<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Camera Test — Vercel</title>
  <style>
    :root { color-scheme: dark light; }
    html,body { margin:0; height:100%; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#000; color:#fff; }
    .wrap { min-height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; padding:16px; }
    video { width:92vw; max-width:720px; aspect-ratio: 9 / 16; background:#111; border-radius:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer; }
    button:active { transform: translateY(1px); }
    pre { max-width:92vw; white-space:pre-wrap; word-break:break-word; background:#111; padding:10px; border-radius:8px; }
    small { opacity:.75 }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Camera Test</h2>
    <video id="view" playsinline autoplay muted></video>

    <div class="row">
      <button id="start">Запустить камеру (тыловая)</button>
      <button id="switch">Переключить фронт/тыл</button>
      <button id="stop">Стоп</button>
    </div>

    <pre id="log">Готово. Нажми «Запустить камеру» и разреши доступ.</pre>
    <small>Требуется HTTPS и явный жест пользователя — политика браузеров.  [oai_citation:4‡MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia?utm_source=chatgpt.com)</small>
  </div>

  <script>
    const v = document.getElementById('view');
    const log = document.getElementById('log');
    const btnStart = document.getElementById('start');
    const btnSwitch = document.getElementById('switch');
    const btnStop = document.getElementById('stop');

    let stream = null;
    let useFront = false;

    function msg(s){ log.textContent = s; }

    async function stopStream(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        v.srcObject = null;
      }
    }

    async function startStream(){
      try{
        await stopStream();
        // iOS Safari: запуск только ПОСЛЕ клика. facingMode через ideal — мягкая попытка
        const constraints = { video: { facingMode: { ideal: useFront ? 'user' : 'environment' } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        v.srcObject = stream;
        msg('Камера запущена (' + (useFront?'фронтальная':'тыловая') + ').');
      }catch(e){
        msg('Ошибка: ' + e.name + ' — ' + e.message + '\n\nПроверь: HTTPS, разрешение сайту на камеру, открой в Safari/Chrome напрямую (не во встроенном браузере).');
        console.error(e);
      }
    }

    btnStart.addEventListener('click', startStream);
    btnSwitch.addEventListener('click', () => { useFront = !useFront; startStream(); });
    btnStop.addEventListener('click', stopStream);

    // Фича-чек:
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      msg('Этот браузер не поддерживает getUserMedia. Открой страницу в Safari/Chrome на телефоне.'); // MDN: API поддержка/HTTPS. 
    }
  </script>
</body>
</html>
